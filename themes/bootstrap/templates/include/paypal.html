<!--
  ~ Copyright (c) 2018 iterate GmbH. All rights reserved.
  -->

<fieldset id="payment-paypal">
    <p class="help-block"></p>
    <div id="await-clienttoken" class="progress">
        <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div>
    </div>
    <div id="paypal-button"></div>
    <script>
                    $(function() {
                        $.get("https://reg.cyberduck.io/paypal/token", function(clientToken) {
                            $("#await-clienttoken").remove();
                            braintree.client.create({
                                authorization: clientToken
                            }, function(clientErr, clientInstance) {
                                // Stop if there was a problem creating the client.
                                // This could happen if there is a network error or if the authorization is invalid.
                                if (clientErr) {
                                    console.error('Error creating client:', clientErr);
                                    return;
                                }
                                // Create a Paypal checkout
                                braintree.paypalCheckout.create({
                                    client: clientInstance
                                }, function(paypalCheckoutErr, paypalCheckoutInstance) {
                                    // Stop if there was a problem creating PayPal Checkout.
                                    // This could happen if there was a network error or if it's incorrectly
                                    // configured.
                                    if (paypalCheckoutErr) {
                                        console.error('Error creating PayPal Checkout:', paypalCheckoutErr);
                                        return;
                                    }
                                    // Set up PayPal with the checkout.js library
                                    paypal.Button.render({
                                        style: {
                                            size: 'medium',
                                            label: 'paypal',
                                            shape: 'rect',
                                            fundingicons: false,
                                            tagline: false,
                                            color: 'white' // 'black', 'silver', 'white'
                                        },
                                        env: 'production',
                                        payment: function() {
                                            return paypalCheckoutInstance.createPayment({
                                                flow: 'checkout', // 'vault'
                                                enableShippingAddress: false,
                                                enableBillingAddress: false,
                                                displayName: 'Cyberduck',
                                                amount: $("#amount").val(),
                                                currency: $("#currency").val(),
                                                intent: 'sale',
                                                landingPageType: 'login',
                                                headless: true
                                            });
                                        },
                                        onAuthorize: function(data, actions) {
                                            return paypalCheckoutInstance.tokenizePayment(data, function(err, payload) {
                                                // Submit `payload.nonce` to your server.
                                                var form = $("#payment");
                                                // Remove previous token if any
                                                form.remove("#token");
                                                // Insert the token into the form so it gets submitted to the server
                                                form.append($("<input id='token' type='hidden' name='paypal-nonce' />").val(payload.nonce));
                                                form.trigger("submit");
                                            });
                                        },
                                        onCancel: function(data) {
                                            console.log('checkout.js cancelled', JSON.stringify(data, 0, 2));
                                            $("#token").remove();
                                        },
                                        onError: function(err) {
                                            console.error('checkout.js error', err);
                                            $("#token").remove();
                                        }
                                    }, '#paypal-button');
                                });
                            });
                        });
                    });
                </script>
</fieldset>
